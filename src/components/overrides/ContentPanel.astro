---
import type { Props } from '@astrojs/starlight/props';
import DocumentMetadata from '../DocumentMetadata.astro';
import fs from 'node:fs';
import path from 'node:path';

// Simple frontmatter parser without external dependencies
function parseFrontmatter(content: string) {
	const match = content.match(/^---\n([\s\S]*?)\n---/);
	if (!match) return null;

	const frontmatterText = match[1];
	const result: any = {};

	// Parse simple YAML key-value pairs
	const lines = frontmatterText.split('\n');
	for (const line of lines) {
		const colonIndex = line.indexOf(':');
		if (colonIndex === -1) continue;

		const key = line.substring(0, colonIndex).trim();
		let value = line.substring(colonIndex + 1).trim();

		// Remove quotes if present
		if ((value.startsWith('"') && value.endsWith('"')) ||
		    (value.startsWith("'") && value.endsWith("'"))) {
			value = value.slice(1, -1);
		}

		result[key] = value;
	}

	return result;
}

// ContentPanel doesn't receive entry prop, so we need to get it from Astro.url
// Extract the slug from the current URL path
const pathSegments = Astro.url.pathname.split('/').filter(Boolean);
const slug = pathSegments.join('/');

// Read the frontmatter directly from the MDX file
// (Starlight's loader strips custom schema fields, so we need to read the raw file)
let metadata = null;
try {
	const filePath = path.join(process.cwd(), 'src', 'content', 'docs', `${slug}.mdx`);

	if (fs.existsSync(filePath)) {
		const fileContent = fs.readFileSync(filePath, 'utf-8');
		const frontmatter = parseFrontmatter(fileContent);

		if (frontmatter?.version) {
			metadata = {
				version: frontmatter.version,
				status: frontmatter.status,
				author: frontmatter.author,
				lastUpdated: frontmatter.lastUpdated ? new Date(frontmatter.lastUpdated) : null,
			};
			console.log(`[ContentPanel] Rendering metadata for: ${slug}`);
		}
	}
} catch (error) {
	// Silently fail - document may not have metadata or may not exist
	console.log(`[ContentPanel] Error or no metadata for: ${slug}`);
}
---

<!-- Reimplemented ContentPanel with metadata injection -->
<div class="content-panel">
	<div class="sl-container">
		<!-- Render the page content passed via slot (includes title) -->
		<slot />

		<!-- Inject metadata component - JavaScript will reposition it after the title -->
		{metadata && (
			<DocumentMetadata
				version={metadata.version}
				status={metadata.status}
				author={metadata.author}
				lastUpdated={metadata.lastUpdated}
			/>
		)}
	</div>
</div>

<style>
	@layer starlight.core {
		.content-panel {
			padding: 1.5rem var(--sl-content-pad-x);
		}
		.content-panel + .content-panel {
			border-top: 1px solid var(--sl-color-hairline);
		}
		.sl-container {
			max-width: var(--sl-content-width);
		}

		.sl-container > :global(* + *) {
			margin-top: 1.5rem;
		}

		@media (min-width: 72rem) {
			.sl-container {
				margin-inline: var(--sl-content-margin-inline, auto);
			}
		}
	}
</style>
